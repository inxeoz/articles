import json
import os
import boto3
import pyotp

REGION = os.environ.get("AWS_REGION", "ap-south-1")
TOTP_SECRET = os.environ["TOTP_SECRET"]
ec2 = boto3.client("ec2", region_name=REGION)
totp = pyotp.TOTP(TOTP_SECRET)

def lambda_handler(event, context):
    body = json.loads(event.get("body") or "{}")
    otp = str(body.get("otp") or "")

    # Verify OTP from Google Authenticator
    if not totp.verify(otp):
        return {"statusCode": 401, "body": json.dumps({"error": "Invalid or expired OTP"})}

    # Start or stop EC2 instance
    action = body.get("action")
    instance_id = body.get("instanceId")
    if action == "start":
        ec2.start_instances(InstanceIds=[instance_id])
        return {"statusCode": 200, "body": json.dumps({"result": f"Started {instance_id}"})}
    elif action == "stop":
        ec2.stop_instances(InstanceIds=[instance_id])
        return {"statusCode": 200, "body": json.dumps({"result": f"Stopped {instance_id}"})}
    else:
        return {"statusCode": 400, "body": json.dumps({"error": "Invalid action"})}
